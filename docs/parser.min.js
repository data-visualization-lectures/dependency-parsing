class DependencyParser{constructor(){this.tokenizer=null,this.initialized=!1}async initialize(){if(!this.initialized)return new Promise((e,t)=>{kuromoji.builder({dicPath:"https://cdn.jsdelivr.net/npm/kuromoji@0.1.2/dict"}).build((n,i)=>{n?t(n):(this.tokenizer=i,this.initialized=!0,e())})})}parse(e){if(!this.initialized||!this.tokenizer)throw new Error("Parser not initialized");const t=this.tokenizer.tokenize(e),n=this.groupIntoBunsetsu(t);return{bunsetsu:n,dependencies:this.estimateDependencies(n),tokens:t}}groupIntoBunsetsu(e){const t=[];let n=[];for(let i=0;i<e.length;i++){const s=e[i];n.push(s);const r=i===e.length-1,o="記号"===s.pos;let d=r||o;if(!d&&i<e.length-1){const t=e[i+1],n=this.isFunctionWord(s),r=this.isContentWord(t);d=n&&r}d&&n.length>0&&(t.push({id:t.length,tokens:n,surface:n.map(e=>e.surface_form).join(""),head:this.findHead(n)}),n=[])}return t}isContentWord(e){return["名詞","動詞","形容詞","副詞","連体詞","感動詞"].includes(e.pos)}isFunctionWord(e){return["助詞","助動詞","接続詞"].includes(e.pos)}findHead(e){const t={"動詞":3,"形容詞":2,"名詞":1};let n=e[0],i=t[n.pos]||0;for(const s of e){const e=t[s.pos]||0;e>i&&(n=s,i=e)}return n}estimateDependencies(e){const t=[];for(let n=0;n<e.length-1;n++){const i=e[n];let s=this.findDependencyTarget(i,n,e);t.push({from:n,to:s,label:this.getDependencyLabel(i,e[s])})}return t}findDependencyTarget(e,t,n){const i=e.tokens[e.tokens.length-1],s=e.head;if(this.isClauseConnector(i))return this.findNextPredicate(t,n);if("助詞"===i.pos){const e=i.surface_form;if(["は","が","を","に","へ","で","から","まで","より","と"].includes(e))return this.findNextVerb(t,n);if("の"===e)return this.findNextNoun(t,n)}if("副詞"===s.pos)return this.findNextPredicate(t,n);if("連体詞"===s.pos)return this.findNextNoun(t,n);if("名詞"===s.pos&&"助詞"!==i.pos)for(let e=t+1;e<n.length;e++){const t=n[e];if("名詞"===t.head.pos||"動詞"===t.head.pos)return e}if("動詞"===s.pos){if("自立"!==s.pos_detail_1||i.surface_form.match(/[てでたりながら]/))return this.findNextPredicate(t,n)}return t+1}isClauseConnector(e){return"助詞"===e.pos?["て","で","ば","と","ても","でも","から","ので","のに","けど","が"].includes(e.surface_form):"助動詞"===e.pos&&["た","だ","です","ます"].includes(e.basic_form)}findNextVerb(e,t){for(let n=e+1;n<t.length;n++)if("動詞"===t[n].head.pos)return n;return t.length-1}findNextNoun(e,t){for(let n=e+1;n<t.length;n++)if("名詞"===t[n].head.pos)return n;return e+1}findNextPredicate(e,t){for(let n=e+1;n<t.length;n++){const e=t[n].head;if("動詞"===e.pos||"形容詞"===e.pos)return n}return t.length-1}getDependencyLabel(e,t){const n=e.tokens[e.tokens.length-1];return"助詞"===n.pos?n.surface_form:""}}const parser=new DependencyParser;