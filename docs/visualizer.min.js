class DependencyVisualizer{constructor(t){this.container=document.getElementById(t),this.svg=null,this.cy=null,this.width=0,this.height=0,this.minBoxWidth=80,this.maxBoxWidth=200,this.boxHeight=60,this.nodeSpacing=20,this.levelSpacing=120,this.nodeSizes={}}visualize(t,e="tree"){this.container.innerHTML="",this.nodeSizes={};const{bunsetsu:i,dependencies:a}=t;if(i&&0!==i.length)switch(this.currentBunsetsu=i,this.currentDependencies=a,e){case"tree":default:this.visualizeTree(i,a);break;case"force":this.visualizeForce(i,a);break;case"cytoscape":this.visualizeCytoscape(i,a)}else this.showPlaceholder("解析結果が空です")}visualizeTree(t,e){this.calculateNodeSizes(t);const i=this.buildHierarchy(t,e);this.calculateDimensions(i);const a=this.container.clientWidth-40;this.width=Math.min(a,this.width),this.maxAllowedWidth=a,this.svg=d3.select(this.container).append("svg").attr("id","dependencyGraph").attr("width",this.width).attr("height",this.height).attr("xmlns","http://www.w3.org/2000/svg").style("display","block").style("margin","0 auto").style("overflow","visible");const s=this.svg.append("g").attr("transform",`translate(${this.width/2}, 50)`),n=d3.tree().nodeSize([this.maxBoxWidth+this.nodeSpacing,this.levelSpacing]).separation((t,e)=>((this.nodeSizes[t.data.id]||this.minBoxWidth)+(this.nodeSizes[e.data.id]||this.minBoxWidth))/(2*this.maxBoxWidth)+.5)(d3.hierarchy(i)),r=d3.max(n.descendants(),t=>t.depth);n.descendants().forEach(t=>{t.y=(r-t.depth)*this.levelSpacing});let o=1/0,l=-1/0,d=1/0,c=-1/0;n.descendants().forEach(t=>{const e=this.nodeSizes[t.data.id]||this.minBoxWidth;o=Math.min(o,t.x-e/2),l=Math.max(l,t.x+e/2),d=Math.min(d,t.y),c=Math.max(c,t.y+this.boxHeight)});const h=l-o;let f=1,p=1;const g=h+80,u=c-d+80;g>this.maxAllowedWidth&&(f=this.maxAllowedWidth/g,p=f);const m=Math.min(this.maxAllowedWidth,g),y=u*p;this.svg.attr("width",m).attr("height",y);const x=(m-h*f)/2-o*f,w=(40-d)*p;s.attr("transform",`translate(${x}, ${w}) scale(${f})`),s.selectAll(".link").data(n.links()).enter().append("path").attr("class","link").attr("d",t=>{const e=t.source.x,i=t.source.y,a=t.target.x,s=t.target.y+this.boxHeight,n=.4*Math.abs(s-i);return`M ${e} ${i}\n                        C ${e} ${i-n},\n                          ${a} ${s+n},\n                          ${a} ${s}`}).attr("fill","none").attr("stroke","#4a90e2").attr("stroke-width",2).attr("opacity",.7);const v=s.selectAll(".node").data(n.descendants()).enter().append("g").attr("class","node").attr("transform",t=>`translate(${t.x}, ${t.y})`);v.append("rect").attr("x",t=>-(this.nodeSizes[t.data.id]||this.minBoxWidth)/2).attr("y",0).attr("width",t=>this.nodeSizes[t.data.id]||this.minBoxWidth).attr("height",this.boxHeight).attr("rx",8).attr("ry",8).attr("fill","#ffffff").attr("stroke","#d0d0d0").attr("stroke-width",2).style("cursor","pointer").on("mouseenter",function(){d3.select(this).attr("fill","#f0f8ff").attr("stroke","#2563eb").attr("stroke-width",3)}).on("mouseleave",function(){d3.select(this).attr("fill","#ffffff").attr("stroke","#d0d0d0").attr("stroke-width",2)}).on("click",(t,e)=>{this.showBunsetsuDetails(e.data.bunsetsu)}),v.append("text").attr("x",t=>-(this.nodeSizes[t.data.id]||this.minBoxWidth)/2+8).attr("y",20).attr("fill","#666666").attr("font-size",12).attr("font-weight",500).text(t=>t.data.id+1),v.append("text").attr("x",0).attr("y",this.boxHeight/2).attr("text-anchor","middle").attr("dominant-baseline","middle").attr("fill","#333333").attr("font-size",14).attr("font-weight",500).text(t=>{const e=t.data.bunsetsu.surface,i=this.nodeSizes[t.data.id]||this.minBoxWidth,a=Math.floor((i-20)/12);return e.length>a?e.substring(0,a-1)+"…":e})}calculateNodeSizes(t){t.forEach((t,e)=>{const i=t.surface.length;let a=Math.ceil(14*i)+40;a=Math.max(this.minBoxWidth,Math.min(a,this.maxBoxWidth)),this.nodeSizes[e]=a})}buildHierarchy(t,e){const i=t.map((t,e)=>({id:e,bunsetsu:t,children:[]}));e.forEach(t=>{i[t.to].children.push(i[t.from])});const a=new Set(e.map(t=>t.from)),s=i.filter((t,e)=>!a.has(e));return s.length>1?{id:-1,bunsetsu:{surface:"ROOT"},children:s}:1===s.length?s[0]:i[0]}calculateDimensions(t){const e=d3.hierarchy(t),i=e.leaves().length,a=e.height;this.width=Math.max(1e3,i*(this.maxBoxWidth+this.nodeSpacing)+200),this.height=Math.max(500,(a+1)*this.levelSpacing+200)}showBunsetsuDetails(t){const e=document.getElementById("infoPanel"),i=document.getElementById("infoContent");let a=`<div class="info-item"><span class="info-label">文節:</span><span class="info-value">${t.surface}</span></div>`;a+=`<div class="info-item"><span class="info-label">主辞:</span><span class="info-value">${t.head.surface_form} (${t.head.pos})</span></div>`,a+='<div class="info-item"><span class="info-label">形態素:</span></div>',t.tokens.forEach(t=>{a+='<div class="info-item" style="margin-left: 1rem;">',a+=`<span class="info-value">${t.surface_form}</span> `,a+=`<span class="info-label">[${t.pos}]</span>`,t.basic_form!==t.surface_form&&(a+=` <span class="info-label">基本形: ${t.basic_form}</span>`),a+="</div>"}),i.innerHTML=a,e.style.display="block"}showPlaceholder(t){this.container.innerHTML=`\n            <div class="placeholder">\n                <div class="placeholder-icon">⚠️</div>\n                <p class="placeholder-text">${t}</p>\n            </div>\n        `}exportSVG(){if(this.cy){const t=this.cy.png({full:!0,bg:"#ffffff"}),e=this.cy.extent().w,i=this.cy.extent().h,a=new Blob([`<?xml version="1.0" encoding="UTF-8" standalone="no"?>\n<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="${e}" height="${i}" viewBox="0 0 ${e} ${i}">\n    <rect width="${e}" height="${i}" fill="#ffffff"/>\n    <image xlink:href="${t}" width="${e}" height="${i}"/>\n</svg>`],{type:"image/svg+xml;charset=utf-8"}),s=URL.createObjectURL(a),n=document.createElement("a");return n.href=s,n.download="dependency-tree.svg",n.click(),void URL.revokeObjectURL(s)}const t=this.container.querySelector("svg");if(!t)return;const e=t.outerHTML,i=new Blob(['<?xml version="1.0" encoding="UTF-8" standalone="no"?>\n'+e],{type:"image/svg+xml;charset=utf-8"}),a=URL.createObjectURL(i),s=document.createElement("a");s.href=a,s.download="dependency-tree.svg",s.click(),URL.revokeObjectURL(a)}exportPNG(){if(this.cy){const t=this.cy.png({full:!0,bg:"#ffffff"}),e=document.createElement("a");return e.href=t,e.download="dependency-tree.png",void e.click()}const t=this.container.querySelector("svg");if(!t)return;const e=t.outerHTML,i=document.createElement("canvas"),a=i.getContext("2d"),s=new Image;i.width=this.width,i.height=this.height,s.onload=()=>{a.fillStyle="#ffffff",a.fillRect(0,0,i.width,i.height),a.drawImage(s,0,0),i.toBlob(t=>{const e=URL.createObjectURL(t),i=document.createElement("a");i.href=e,i.download="dependency-tree.png",i.click(),URL.revokeObjectURL(e)})},s.src="data:image/svg+xml;base64,"+btoa(unescape(encodeURIComponent(e)))}visualizeForce(t,e){const i=25,a=t.map((t,e)=>({id:e,bunsetsu:t,surface:t.surface,radius:i})),s=e.map(t=>({source:t.from,target:t.to,label:t.label})),n=this.container.clientWidth-40;this.width=Math.min(n,1200),this.height=Math.max(600,window.innerHeight-400),this.svg=d3.select(this.container).append("svg").attr("id","dependencyGraph").attr("width",this.width).attr("height",this.height).attr("xmlns","http://www.w3.org/2000/svg").style("display","block").style("margin","0 auto");const r=this.svg.append("g"),o=d3.forceSimulation(a).force("link",d3.forceLink(s).id(t=>t.id).distance(100).strength(.5)).force("charge",d3.forceManyBody().strength(-300)).force("center",d3.forceCenter(this.width/2,this.height/2)).force("collide",d3.forceCollide().radius(30)),l=r.selectAll(".link").data(s).enter().append("line").attr("class","link").attr("stroke","#4a90e2").attr("stroke-width",2).attr("opacity",.6).attr("marker-end","url(#arrowhead)");this.svg.append("defs").append("marker").attr("id","arrowhead").attr("markerWidth",10).attr("markerHeight",10).attr("refX",25).attr("refY",3).attr("orient","auto").append("polygon").attr("points","0 0, 10 3, 0 6").attr("fill","#4a90e2");const d=r.selectAll(".node").data(a).enter().append("g").attr("class","node").call(d3.drag().on("start",(t,e)=>{t.active||o.alphaTarget(.3).restart(),e.fx=e.x,e.fy=e.y}).on("drag",(t,e)=>{e.fx=t.x,e.fy=t.y}).on("end",(t,e)=>{t.active||o.alphaTarget(0),e.fx=null,e.fy=null}));d.append("circle").attr("r",i).attr("fill","#ffffff").attr("stroke","#4a90e2").attr("stroke-width",2).style("cursor","pointer").on("mouseenter",function(t,e){d3.select(this).attr("r",30).attr("fill","#f0f8ff").attr("stroke-width",3),l.style("opacity",t=>t.source.id===e.id||t.target.id===e.id?1:.2),d.selectAll("circle").style("opacity",t=>t.id===e.id||s.some(i=>i.source.id===e.id&&i.target.id===t.id||i.target.id===e.id&&i.source.id===t.id)?1:.4)}).on("mouseleave",function(){d3.select(this).attr("r",i).attr("fill","#ffffff").attr("stroke-width",2).style("opacity",1),l.style("opacity",.6)}).on("click",(t,e)=>{this.showBunsetsuDetails(e.bunsetsu)}),d.append("text").attr("x",0).attr("y",45).attr("text-anchor","middle").attr("fill","#333333").attr("font-size",11).attr("font-weight",500).text(t=>t.surface).style("pointer-events","none").style("user-select","none"),o.on("tick",()=>{l.attr("x1",t=>t.source.x).attr("y1",t=>t.source.y).attr("x2",t=>t.target.x).attr("y2",t=>t.target.y),d.attr("transform",t=>`translate(${t.x}, ${t.y})`)})}visualizeCytoscape(t,e){const i=this.container.clientWidth-40,a=Math.max(600,window.innerHeight-400),s=document.createElement("div");s.id="cytoscape-container",s.style.width=i+"px",s.style.height=a+"px",s.style.margin="0 auto",this.container.appendChild(s);const n=t.map((t,e)=>({data:{id:`node-${e}`,label:t.surface}})),r=e.map((t,e)=>({data:{id:`edge-${e}`,source:`node-${t.from}`,target:`node-${t.to}`,label:t.label}}));this.cy=window.cytoscape({container:s,elements:n.concat(r),style:[{selector:"node",style:{"background-color":"#11479e",content:"data(label)","text-valign":"center","text-halign":"center",color:"#ffffff","font-size":12,"font-weight":500,padding:"8px"}},{selector:"edge",style:{width:4,"target-arrow-shape":"triangle","line-color":"#9dbaea","target-arrow-color":"#9dbaea","curve-style":"bezier"}}],wheelSensitivity:.1}),this.cy.layout({name:"dagre",directed:!0,rankDir:"TB",animate:!1,spacingFactor:1.2}).run(),this.cy.on("tap","node",e=>{const i=parseInt(e.target.id().split("-")[1]);this.showBunsetsuDetails(t[i])}),this.cy.fit()}}const visualizer=new DependencyVisualizer("visualizationContainer");