class DependencyVisualizer{constructor(t){this.container=document.getElementById(t),this.svg=null,this.width=0,this.height=0,this.minBoxWidth=80,this.maxBoxWidth=200,this.boxHeight=60,this.nodeSpacing=20,this.levelSpacing=120,this.nodeSizes={}}visualize(t,e="tree"){this.container.innerHTML="",this.nodeSizes={};const{bunsetsu:a,dependencies:i}=t;if(a&&0!==a.length)switch(this.currentBunsetsu=a,this.currentDependencies=i,e){case"tree":default:this.visualizeTree(a,i);break;case"force":this.visualizeForce(a,i);break;case"cytoscape":this.visualizeCytoscape(a,i)}else this.showPlaceholder("解析結果が空です")}visualizeTree(t,e){this.calculateNodeSizes(t);const a=this.buildHierarchy(t,e);this.calculateDimensions(a);const i=this.container.clientWidth-40;this.width=Math.min(i,this.width),this.maxAllowedWidth=i,this.svg=d3.select(this.container).append("svg").attr("id","dependencyGraph").attr("width",this.width).attr("height",this.height).attr("xmlns","http://www.w3.org/2000/svg").style("display","block").style("margin","0 auto").style("overflow","visible");const s=this.svg.append("g").attr("transform",`translate(${this.width/2}, 50)`),n=d3.tree().nodeSize([this.maxBoxWidth+this.nodeSpacing,this.levelSpacing]).separation((t,e)=>((this.nodeSizes[t.data.id]||this.minBoxWidth)+(this.nodeSizes[e.data.id]||this.minBoxWidth))/(2*this.maxBoxWidth)+.5)(d3.hierarchy(a)),r=d3.max(n.descendants(),t=>t.depth);n.descendants().forEach(t=>{t.y=(r-t.depth)*this.levelSpacing});let o=1/0,d=-1/0,l=1/0,h=-1/0;n.descendants().forEach(t=>{const e=this.nodeSizes[t.data.id]||this.minBoxWidth;o=Math.min(o,t.x-e/2),d=Math.max(d,t.x+e/2),l=Math.min(l,t.y),h=Math.max(h,t.y+this.boxHeight)});const c=d-o;let f=1,p=1;const u=c+80,g=h-l+80;u>this.maxAllowedWidth&&(f=this.maxAllowedWidth/u,p=f);const m=Math.min(this.maxAllowedWidth,u),y=g*p;this.svg.attr("width",m).attr("height",y);const x=(m-c*f)/2-o*f,w=(40-l)*p;s.attr("transform",`translate(${x}, ${w}) scale(${f})`),s.selectAll(".link").data(n.links()).enter().append("path").attr("class","link").attr("d",t=>{const e=t.source.x,a=t.source.y,i=t.target.x,s=t.target.y+this.boxHeight,n=.4*Math.abs(s-a);return`M ${e} ${a}\n                        C ${e} ${a-n},\n                          ${i} ${s+n},\n                          ${i} ${s}`}).attr("fill","none").attr("stroke","#4a90e2").attr("stroke-width",2).attr("opacity",.7);const v=s.selectAll(".node").data(n.descendants()).enter().append("g").attr("class","node").attr("transform",t=>`translate(${t.x}, ${t.y})`);v.append("rect").attr("x",t=>-(this.nodeSizes[t.data.id]||this.minBoxWidth)/2).attr("y",0).attr("width",t=>this.nodeSizes[t.data.id]||this.minBoxWidth).attr("height",this.boxHeight).attr("rx",8).attr("ry",8).attr("fill","#ffffff").attr("stroke","#d0d0d0").attr("stroke-width",2).style("cursor","pointer").on("mouseenter",function(){d3.select(this).attr("fill","#f0f8ff").attr("stroke","#2563eb").attr("stroke-width",3)}).on("mouseleave",function(){d3.select(this).attr("fill","#ffffff").attr("stroke","#d0d0d0").attr("stroke-width",2)}).on("click",(t,e)=>{this.showBunsetsuDetails(e.data.bunsetsu)}),v.append("text").attr("x",t=>-(this.nodeSizes[t.data.id]||this.minBoxWidth)/2+8).attr("y",20).attr("fill","#666666").attr("font-size",12).attr("font-weight",500).text(t=>t.data.id+1),v.append("text").attr("x",0).attr("y",this.boxHeight/2).attr("text-anchor","middle").attr("dominant-baseline","middle").attr("fill","#333333").attr("font-size",14).attr("font-weight",500).text(t=>{const e=t.data.bunsetsu.surface,a=this.nodeSizes[t.data.id]||this.minBoxWidth,i=Math.floor((a-20)/12);return e.length>i?e.substring(0,i-1)+"…":e})}calculateNodeSizes(t){t.forEach((t,e)=>{const a=t.surface.length;let i=Math.ceil(14*a)+40;i=Math.max(this.minBoxWidth,Math.min(i,this.maxBoxWidth)),this.nodeSizes[e]=i})}buildHierarchy(t,e){const a=t.map((t,e)=>({id:e,bunsetsu:t,children:[]}));e.forEach(t=>{a[t.to].children.push(a[t.from])});const i=new Set(e.map(t=>t.from)),s=a.filter((t,e)=>!i.has(e));return s.length>1?{id:-1,bunsetsu:{surface:"ROOT"},children:s}:1===s.length?s[0]:a[0]}calculateDimensions(t){const e=d3.hierarchy(t),a=e.leaves().length,i=e.height;this.width=Math.max(1e3,a*(this.maxBoxWidth+this.nodeSpacing)+200),this.height=Math.max(500,(i+1)*this.levelSpacing+200)}showBunsetsuDetails(t){const e=document.getElementById("infoPanel"),a=document.getElementById("infoContent");let i=`<div class="info-item"><span class="info-label">文節:</span><span class="info-value">${t.surface}</span></div>`;i+=`<div class="info-item"><span class="info-label">主辞:</span><span class="info-value">${t.head.surface_form} (${t.head.pos})</span></div>`,i+='<div class="info-item"><span class="info-label">形態素:</span></div>',t.tokens.forEach(t=>{i+='<div class="info-item" style="margin-left: 1rem;">',i+=`<span class="info-value">${t.surface_form}</span> `,i+=`<span class="info-label">[${t.pos}]</span>`,t.basic_form!==t.surface_form&&(i+=` <span class="info-label">基本形: ${t.basic_form}</span>`),i+="</div>"}),a.innerHTML=i,e.style.display="block"}showPlaceholder(t){this.container.innerHTML=`\n            <div class="placeholder">\n                <div class="placeholder-icon">⚠️</div>\n                <p class="placeholder-text">${t}</p>\n            </div>\n        `}exportSVG(){const t=this.container.querySelector("svg");if(!t)return;const e=t.outerHTML,a=new Blob(['<?xml version="1.0" encoding="UTF-8" standalone="no"?>\n'+e],{type:"image/svg+xml;charset=utf-8"}),i=URL.createObjectURL(a),s=document.createElement("a");s.href=i,s.download="dependency-tree.svg",s.click(),URL.revokeObjectURL(i)}exportPNG(){const t=this.container.querySelector("svg");if(!t)return;const e=t.outerHTML,a=document.createElement("canvas"),i=a.getContext("2d"),s=new Image;a.width=this.width,a.height=this.height,s.onload=()=>{i.fillStyle="#ffffff",i.fillRect(0,0,a.width,a.height),i.drawImage(s,0,0),a.toBlob(t=>{const e=URL.createObjectURL(t),a=document.createElement("a");a.href=e,a.download="dependency-tree.png",a.click(),URL.revokeObjectURL(e)})},s.src="data:image/svg+xml;base64,"+btoa(unescape(encodeURIComponent(e)))}visualizeForce(t,e){const a=25,i=t.map((t,e)=>({id:e,bunsetsu:t,surface:t.surface,radius:a})),s=e.map(t=>({source:t.from,target:t.to,label:t.label})),n=this.container.clientWidth-40;this.width=Math.min(n,1200),this.height=Math.max(600,window.innerHeight-400),this.svg=d3.select(this.container).append("svg").attr("id","dependencyGraph").attr("width",this.width).attr("height",this.height).attr("xmlns","http://www.w3.org/2000/svg").style("display","block").style("margin","0 auto");const r=this.svg.append("g"),o=d3.forceSimulation(i).force("link",d3.forceLink(s).id(t=>t.id).distance(100).strength(.5)).force("charge",d3.forceManyBody().strength(-300)).force("center",d3.forceCenter(this.width/2,this.height/2)).force("collide",d3.forceCollide().radius(30)),d=r.selectAll(".link").data(s).enter().append("line").attr("class","link").attr("stroke","#4a90e2").attr("stroke-width",2).attr("opacity",.6).attr("marker-end","url(#arrowhead)");this.svg.append("defs").append("marker").attr("id","arrowhead").attr("markerWidth",10).attr("markerHeight",10).attr("refX",25).attr("refY",3).attr("orient","auto").append("polygon").attr("points","0 0, 10 3, 0 6").attr("fill","#4a90e2");const l=r.selectAll(".node").data(i).enter().append("g").attr("class","node").call(d3.drag().on("start",(t,e)=>{t.active||o.alphaTarget(.3).restart(),e.fx=e.x,e.fy=e.y}).on("drag",(t,e)=>{e.fx=t.x,e.fy=t.y}).on("end",(t,e)=>{t.active||o.alphaTarget(0),e.fx=null,e.fy=null}));l.append("circle").attr("r",a).attr("fill","#ffffff").attr("stroke","#4a90e2").attr("stroke-width",2).style("cursor","pointer").on("mouseenter",function(t,e){d3.select(this).attr("r",30).attr("fill","#f0f8ff").attr("stroke-width",3),d.style("opacity",t=>t.source.id===e.id||t.target.id===e.id?1:.2),l.selectAll("circle").style("opacity",t=>t.id===e.id||s.some(a=>a.source.id===e.id&&a.target.id===t.id||a.target.id===e.id&&a.source.id===t.id)?1:.4)}).on("mouseleave",function(){d3.select(this).attr("r",a).attr("fill","#ffffff").attr("stroke-width",2).style("opacity",1),d.style("opacity",.6)}).on("click",(t,e)=>{this.showBunsetsuDetails(e.bunsetsu)}),l.append("text").attr("x",0).attr("y",45).attr("text-anchor","middle").attr("fill","#333333").attr("font-size",11).attr("font-weight",500).text(t=>t.surface).style("pointer-events","none").style("user-select","none"),o.on("tick",()=>{d.attr("x1",t=>t.source.x).attr("y1",t=>t.source.y).attr("x2",t=>t.target.x).attr("y2",t=>t.target.y),l.attr("transform",t=>`translate(${t.x}, ${t.y})`)})}visualizeCytoscape(t,e){const a=this.container.clientWidth-40,i=Math.max(600,window.innerHeight-400),s=document.createElement("div");s.id="cytoscape-container",s.style.width=a+"px",s.style.height=i+"px",s.style.margin="0 auto",this.container.appendChild(s);const n=t.map((t,e)=>({data:{id:`node-${e}`,label:t.surface}})),r=e.map((t,e)=>({data:{id:`edge-${e}`,source:`node-${t.from}`,target:`node-${t.to}`,label:t.label}})),o=window.cytoscape({container:s,elements:n.concat(r),style:[{selector:"node",style:{"background-color":"#11479e",content:"data(label)","text-valign":"center","text-halign":"center",color:"#ffffff","font-size":12,"font-weight":500,padding:"8px"}},{selector:"edge",style:{width:4,"target-arrow-shape":"triangle","line-color":"#9dbaea","target-arrow-color":"#9dbaea","curve-style":"bezier"}}],wheelSensitivity:.1});o.layout({name:"dagre",directed:!0,rankDir:"TB",animate:!1,spacingFactor:1.2}).run(),o.on("tap","node",e=>{const a=parseInt(e.target.id().split("-")[1]);this.showBunsetsuDetails(t[a])}),o.fit()}}const visualizer=new DependencyVisualizer("visualizationContainer");