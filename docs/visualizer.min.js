class DependencyVisualizer{constructor(t){this.container=document.getElementById(t),this.svg=null,this.width=0,this.height=0,this.minBoxWidth=80,this.maxBoxWidth=200,this.boxHeight=60,this.nodeSpacing=20,this.levelSpacing=120,this.nodeSizes={}}visualize(t,e="tree"){this.container.innerHTML="",this.nodeSizes={};const{bunsetsu:a,dependencies:s}=t;if(a&&0!==a.length)switch(this.currentBunsetsu=a,this.currentDependencies=s,e){case"tree":default:this.visualizeTree(a,s);break;case"force":this.visualizeForce(a,s);break;case"sankey":this.visualizeSankey(a,s);break;case"sunburst":this.visualizeSunburst(a,s)}else this.showPlaceholder("解析結果が空です")}visualizeTree(t,e){this.calculateNodeSizes(t);const a=this.buildHierarchy(t,e);this.calculateDimensions(a);const s=this.container.clientWidth-40;this.width=Math.min(s,this.width),this.svg=d3.select(this.container).append("svg").attr("id","dependencyGraph").attr("width",this.width).attr("height",this.height).attr("xmlns","http://www.w3.org/2000/svg").style("display","block").style("margin","0 auto");const i=this.svg.append("g").attr("transform",`translate(${this.width/2}, 50)`),n=d3.tree().nodeSize([this.maxBoxWidth+this.nodeSpacing,this.levelSpacing]).separation((t,e)=>((this.nodeSizes[t.data.id]||this.minBoxWidth)+(this.nodeSizes[e.data.id]||this.minBoxWidth))/(2*this.maxBoxWidth)+.5)(d3.hierarchy(a)),r=d3.max(n.descendants(),t=>t.depth);n.descendants().forEach(t=>{t.y=(r-t.depth)*this.levelSpacing});let o=1/0,h=-1/0,d=1/0,l=-1/0;n.descendants().forEach(t=>{const e=this.nodeSizes[t.data.id]||this.minBoxWidth;o=Math.min(o,t.x-e/2),h=Math.max(h,t.x+e/2),d=Math.min(d,t.y),l=Math.max(l,t.y+this.boxHeight)});const c=h-o,u=l-d;this.width=Math.max(this.width,c+80),this.height=Math.max(this.height,u+80),this.svg.attr("width",this.width).attr("height",this.height);const p=(this.width-c)/2-o,f=40-d;i.attr("transform",`translate(${p}, ${f})`),i.selectAll(".link").data(n.links()).enter().append("path").attr("class","link").attr("d",t=>{const e=t.source.x,a=t.source.y,s=t.target.x,i=t.target.y+this.boxHeight,n=.4*Math.abs(i-a);return`M ${e} ${a}\n                        C ${e} ${a-n},\n                          ${s} ${i+n},\n                          ${s} ${i}`}).attr("fill","none").attr("stroke","#4a90e2").attr("stroke-width",2).attr("opacity",.7);const g=i.selectAll(".node").data(n.descendants()).enter().append("g").attr("class","node").attr("transform",t=>`translate(${t.x}, ${t.y})`);g.append("rect").attr("x",t=>-(this.nodeSizes[t.data.id]||this.minBoxWidth)/2).attr("y",0).attr("width",t=>this.nodeSizes[t.data.id]||this.minBoxWidth).attr("height",this.boxHeight).attr("rx",8).attr("ry",8).attr("fill","#ffffff").attr("stroke","#d0d0d0").attr("stroke-width",2).style("cursor","pointer").on("mouseenter",function(){d3.select(this).attr("fill","#f0f8ff").attr("stroke","#2563eb").attr("stroke-width",3)}).on("mouseleave",function(){d3.select(this).attr("fill","#ffffff").attr("stroke","#d0d0d0").attr("stroke-width",2)}).on("click",(t,e)=>{this.showBunsetsuDetails(e.data.bunsetsu)}),g.append("text").attr("x",t=>-(this.nodeSizes[t.data.id]||this.minBoxWidth)/2+8).attr("y",20).attr("fill","#666666").attr("font-size",12).attr("font-weight",500).text(t=>t.data.id+1),g.append("text").attr("x",0).attr("y",this.boxHeight/2).attr("text-anchor","middle").attr("dominant-baseline","middle").attr("fill","#333333").attr("font-size",14).attr("font-weight",500).text(t=>{const e=t.data.bunsetsu.surface,a=this.nodeSizes[t.data.id]||this.minBoxWidth,s=Math.floor((a-20)/12);return e.length>s?e.substring(0,s-1)+"…":e})}calculateNodeSizes(t){t.forEach((t,e)=>{const a=t.surface.length;let s=Math.ceil(14*a)+40;s=Math.max(this.minBoxWidth,Math.min(s,this.maxBoxWidth)),this.nodeSizes[e]=s})}buildHierarchy(t,e){const a=t.map((t,e)=>({id:e,bunsetsu:t,children:[]}));e.forEach(t=>{a[t.to].children.push(a[t.from])});const s=new Set(e.map(t=>t.from)),i=a.filter((t,e)=>!s.has(e));return i.length>1?{id:-1,bunsetsu:{surface:"ROOT"},children:i}:1===i.length?i[0]:a[0]}calculateDimensions(t){const e=d3.hierarchy(t),a=e.leaves().length,s=e.height;this.width=Math.max(1e3,a*(this.maxBoxWidth+this.nodeSpacing)+200),this.height=Math.max(500,(s+1)*this.levelSpacing+200)}showBunsetsuDetails(t){const e=document.getElementById("infoPanel"),a=document.getElementById("infoContent");let s=`<div class="info-item"><span class="info-label">文節:</span><span class="info-value">${t.surface}</span></div>`;s+=`<div class="info-item"><span class="info-label">主辞:</span><span class="info-value">${t.head.surface_form} (${t.head.pos})</span></div>`,s+='<div class="info-item"><span class="info-label">形態素:</span></div>',t.tokens.forEach(t=>{s+='<div class="info-item" style="margin-left: 1rem;">',s+=`<span class="info-value">${t.surface_form}</span> `,s+=`<span class="info-label">[${t.pos}]</span>`,t.basic_form!==t.surface_form&&(s+=` <span class="info-label">基本形: ${t.basic_form}</span>`),s+="</div>"}),a.innerHTML=s,e.style.display="block"}showPlaceholder(t){this.container.innerHTML=`\n            <div class="placeholder">\n                <div class="placeholder-icon">⚠️</div>\n                <p class="placeholder-text">${t}</p>\n            </div>\n        `}exportSVG(){const t=this.container.querySelector("svg");if(!t)return;const e=t.outerHTML,a=new Blob(['<?xml version="1.0" encoding="UTF-8" standalone="no"?>\n'+e],{type:"image/svg+xml;charset=utf-8"}),s=URL.createObjectURL(a),i=document.createElement("a");i.href=s,i.download="dependency-tree.svg",i.click(),URL.revokeObjectURL(s)}exportPNG(){const t=this.container.querySelector("svg");if(!t)return;const e=t.outerHTML,a=document.createElement("canvas"),s=a.getContext("2d"),i=new Image;a.width=this.width,a.height=this.height,i.onload=()=>{s.fillStyle="#ffffff",s.fillRect(0,0,a.width,a.height),s.drawImage(i,0,0),a.toBlob(t=>{const e=URL.createObjectURL(t),a=document.createElement("a");a.href=e,a.download="dependency-tree.png",a.click(),URL.revokeObjectURL(e)})},i.src="data:image/svg+xml;base64,"+btoa(unescape(encodeURIComponent(e)))}visualizeForce(t,e){const a=25,s=t.map((t,e)=>({id:e,bunsetsu:t,surface:t.surface,radius:a})),i=e.map(t=>({source:t.from,target:t.to,label:t.label})),n=this.container.clientWidth-40;this.width=Math.min(n,1200),this.height=Math.max(600,window.innerHeight-400),this.svg=d3.select(this.container).append("svg").attr("id","dependencyGraph").attr("width",this.width).attr("height",this.height).attr("xmlns","http://www.w3.org/2000/svg").style("display","block").style("margin","0 auto");const r=this.svg.append("g"),o=d3.forceSimulation(s).force("link",d3.forceLink(i).id(t=>t.id).distance(100).strength(.5)).force("charge",d3.forceManyBody().strength(-300)).force("center",d3.forceCenter(this.width/2,this.height/2)).force("collide",d3.forceCollide().radius(30)),h=r.selectAll(".link").data(i).enter().append("line").attr("class","link").attr("stroke","#4a90e2").attr("stroke-width",2).attr("opacity",.6).attr("marker-end","url(#arrowhead)");this.svg.append("defs").append("marker").attr("id","arrowhead").attr("markerWidth",10).attr("markerHeight",10).attr("refX",25).attr("refY",3).attr("orient","auto").append("polygon").attr("points","0 0, 10 3, 0 6").attr("fill","#4a90e2");const d=r.selectAll(".node").data(s).enter().append("g").attr("class","node").call(d3.drag().on("start",(t,e)=>{t.active||o.alphaTarget(.3).restart(),e.fx=e.x,e.fy=e.y}).on("drag",(t,e)=>{e.fx=t.x,e.fy=t.y}).on("end",(t,e)=>{t.active||o.alphaTarget(0),e.fx=null,e.fy=null}));d.append("circle").attr("r",a).attr("fill","#ffffff").attr("stroke","#4a90e2").attr("stroke-width",2).style("cursor","pointer").on("mouseenter",function(t,e){d3.select(this).attr("r",30).attr("fill","#f0f8ff").attr("stroke-width",3),h.style("opacity",t=>t.source.id===e.id||t.target.id===e.id?1:.2),d.selectAll("circle").style("opacity",t=>t.id===e.id||i.some(a=>a.source.id===e.id&&a.target.id===t.id||a.target.id===e.id&&a.source.id===t.id)?1:.4)}).on("mouseleave",function(){d3.select(this).attr("r",a).attr("fill","#ffffff").attr("stroke-width",2).style("opacity",1),h.style("opacity",.6)}).on("click",(t,e)=>{this.showBunsetsuDetails(e.bunsetsu)}),d.append("text").attr("x",0).attr("y",45).attr("text-anchor","middle").attr("fill","#333333").attr("font-size",11).attr("font-weight",500).text(t=>t.surface).style("pointer-events","none").style("user-select","none"),o.on("tick",()=>{h.attr("x1",t=>t.source.x).attr("y1",t=>t.source.y).attr("x2",t=>t.target.x).attr("y2",t=>t.target.y),d.attr("transform",t=>`translate(${t.x}, ${t.y})`)})}visualizeSankey(t,e){const a=t.map((t,e)=>({id:e,name:t.surface,bunsetsu:t})),s=e.map(t=>({source:t.from,target:t.to,value:1,label:t.label})),i=this.container.clientWidth-40;this.width=Math.min(i,1200),this.height=Math.max(400,60*t.length),this.svg=d3.select(this.container).append("svg").attr("id","dependencyGraph").attr("width",this.width).attr("height",this.height).attr("xmlns","http://www.w3.org/2000/svg").style("display","block").style("margin","0 auto");const n=this.svg.append("g"),r=d3.sankey().nodeWidth(15).nodePadding(50).extent([[1,1],[this.width-1,this.height-6]]),{nodes:o,links:h}=r({nodes:a.map(t=>({...t})),links:s.map(t=>({...t}))}),d=d3.scaleOrdinal(d3.schemeCategory10),l=n.selectAll(".link").data(h).enter().append("path").attr("class","link").attr("d",d3.sankeyLinkHorizontal()).attr("stroke",t=>d(t.source.id)).attr("stroke-opacity",.5).attr("stroke-width",t=>Math.max(1,t.width));n.selectAll(".link-label").data(h).enter().append("text").attr("class","link-label").attr("x",t=>(t.source.x+t.target.x)/2).attr("y",t=>(t.source.y+t.target.y)/2-5).attr("text-anchor","middle").attr("font-size",10).attr("fill","#666").text(t=>t.label).style("pointer-events","none").style("opacity",.7);const c=n.selectAll(".node").data(o).enter().append("g").attr("class","node");c.append("rect").attr("x",t=>t.x0).attr("y",t=>t.y0).attr("height",t=>t.y1-t.y0).attr("width",t=>t.x1-t.x0).attr("fill",t=>d(t.id)).attr("stroke","#333").style("cursor","pointer").on("mouseenter",function(t,e){d3.select(this).attr("stroke-width",2).attr("opacity",.9),l.style("stroke-opacity",t=>t.source.id===e.id||t.target.id===e.id?1:.2),c.selectAll("rect").style("opacity",t=>t.id===e.id||h.some(a=>a.source.id===e.id&&a.target.id===t.id||a.target.id===e.id&&a.source.id===t.id)?1:.4)}).on("mouseleave",function(){d3.select(this).attr("stroke-width",1).attr("opacity",1),c.selectAll("rect").style("opacity",1),l.style("stroke-opacity",.5)}).on("click",(t,e)=>{this.showBunsetsuDetails(e.bunsetsu)}),c.append("text").attr("x",t=>t.x0<this.width/2?t.x1+6:t.x0-6).attr("y",t=>(t.y0+t.y1)/2).attr("dy","0.35em").attr("text-anchor",t=>t.x0<this.width/2?"start":"end").attr("font-size",12).attr("font-weight",500).text(t=>t.name).style("pointer-events","none")}visualizeSunburst(t,e){const a=this.buildHierarchy(t,e),s=this.container.clientWidth-40,i=Math.min(300,s/2-50);this.width=2*i+100,this.height=2*i+100,this.svg=d3.select(this.container).append("svg").attr("id","dependencyGraph").attr("width",this.width).attr("height",this.height).attr("xmlns","http://www.w3.org/2000/svg").style("display","block").style("margin","0 auto");const n=this.svg.append("g").attr("transform",`translate(${this.width/2}, ${this.height/2})`),r=d3.scaleOrdinal(d3.schemeCategory10),o=d3.partition().size([2*Math.PI,i])(d3.hierarchy(a).sum(t=>1).sort((t,e)=>e.value-t.value)).descendants(),h=d3.arc().startAngle(t=>t.x0).endAngle(t=>t.x1).innerRadius(t=>t.y0).outerRadius(t=>t.y1),d=n.selectAll(".slice").data(o).enter().append("g").attr("class","slice");d.append("path").attr("class","sunburst-path").attr("d",h).attr("fill",(t,e)=>r(e%10)).attr("stroke","#fff").attr("stroke-width",2).style("cursor",t=>t.depth>0?"pointer":"default").on("mouseenter",function(t,e){d3.select(this).attr("stroke-width",3).attr("opacity",.9).style("filter","brightness(1.2)"),d.selectAll(".sunburst-path").style("opacity",t=>t.parent===e||e.parent===t||t===e?1:.3)}).on("mouseleave",function(){d3.selectAll(".sunburst-path").attr("stroke-width",2).attr("opacity",1).style("filter","none")}).on("click",(t,e)=>{e.data.bunsetsu&&this.showBunsetsuDetails(e.data.bunsetsu)}),d.append("text").attr("transform",t=>{const e=(t.x0+t.x1)/2,a=(t.y0+t.y1)/2;return`rotate(${180*e/Math.PI-90})translate(${a},0)`}).attr("text-anchor",t=>(t.x0+t.x1)/2>Math.PI?"end":"start").attr("transform",t=>{const e=(t.x0+t.x1)/2,a=(t.y0+t.y1)/2;return`rotate(${180*e/Math.PI-90})translate(${a},0)rotate(${e>Math.PI?180:0})`}).attr("font-size",t=>Math.max(8,16-3*t.depth)).attr("fill","#333").attr("dominant-baseline","middle").text(t=>{const e=t.data.bunsetsu?t.data.bunsetsu.surface:"ROOT";return e.length>4?e.substring(0,3)+".":e}).style("pointer-events","none")}}const visualizer=new DependencyVisualizer("visualizationContainer");